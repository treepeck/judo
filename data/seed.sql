-- Create tables.

CREATE TABLE IF NOT EXISTS player (
	id CHAR(12) BINARY PRIMARY KEY,
	name VARCHAR(60) NOT NULL UNIQUE,
	rating FLOAT NOT NULL DEFAULT 1500,
	rating_deviation FLOAT NOT NULL DEFAULT 350.0,
	rating_volatility FLOAT NOT NULL DEFAULT 0.06,
	email VARCHAR(100) NOT NULL UNIQUE,
	password_hash BINARY(60) NOT NULL,
	created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
	updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS session (
	id CHAR(32) BINARY PRIMARY KEY,
	player_id CHAR(12) BINARY NOT NULL,
	created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
	expires_at DATETIME AS (created_at + INTERVAL 720 HOUR) STORED,
	FOREIGN KEY (player_id) REFERENCES player(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS game (
	id CHAR(12) BINARY PRIMARY KEY,
	white_id CHAR(12) BINARY NOT NULL,
	black_id CHAR(12) BINARY NOT NULL,
	result ENUM('0-1', '1-0', '1/2-1/2', '*'),
	termination ENUM('abandoned', 'adjudication', 'normal', 'rules infraction',
	'time forfeit', 'unterminated'),
	created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
	FOREIGN KEY (white_id) REFERENCES player(id),
	FOREIGN KEY (black_id) REFERENCES player(id)
);

CREATE EVENT IF NOT EXISTS delete_expired_session
ON SCHEDULE EVERY 6 HOUR
DO DELETE FROM session WHERE expires_at < NOW();
-- Insert test users.

-- Password = fischer
INSERT INTO player (id, name, email, password_hash) VALUES
("By7V1XnOiu8i", "bobby", "bobby@fischer.com",
X'2432612431302463755A79332E586974764C56434B63544644635355754F686945464734346E2E414F4A71646F4E4D54784E344A6C54495A70646F61');

-- Password = carlsen
INSERT INTO player (id, name, email, password_hash) VALUES
("h4wtjt3lxM-v", "magnus", "magnus@carlsen.com",
X'243261243130244B4A52317347505A3332665047353577364354767A6568536F4F46635948636265556A77574930346D45544D79326C6F5044736579');

-- Password = dommaraju
INSERT INTO player (id, name, email, password_hash) VALUES
("Xjmv5xqMzoC3", "gukesh", "gukesh@dommaraju.com",
X'2432612431302437694F47644865436451304D344B7A2E6747444378655778504A746B5A442F422F50504779734F53726E613773533330732F4C7769');

-- Password = liren
INSERT INTO player (id, name, email, password_hash) VALUES
("wPqtM4YadqbW", "ding", "ding@liren.com",
X'24326124313024714A3579387261374D5366794C73664F466D75657A4F657A3369366A5148523244484F535469474830556451556359716365595447');

-- Insert test session.
INSERT INTO session (id, player_id) VALUES ("57w_sbICMc9znzXepVw2RskBDg_W94H1",
"Xjmv5xqMzoC3");